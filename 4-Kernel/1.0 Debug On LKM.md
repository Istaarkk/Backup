## âœ… Objectif

Un setup clean pour :

- **Recompiler** le module `vuln.ko` avec debug,
    
- **Modifier et repacker** l'`initramfs` avec un `init` qui donne un shell root,
    
- **Lancer QEMU** en mode debug (`-s`) avec `new-initramfs.img`,
    
- **Attacher GDB** au kernel (`vmlinux`) et debugger `vuln.ko`.

Exemple de structure: 
```php
handout/
â”œâ”€â”€ bzImage                # Noyau compilÃ© avec DEBUG_INFO
â”œâ”€â”€ vmlinux                # Binaire debug pour GDB
â”œâ”€â”€ initrd.cpio.gz         # Initramfs de base (challenge)
â”œâ”€â”€ new-initramfs.img      # Initramfs modifiÃ© (debug/root)
â”œâ”€â”€ vuln/                  # Module vulnÃ©rable
â”‚   â”œâ”€â”€ vuln.c
â”‚   â”œâ”€â”€ Makefile
â”œâ”€â”€ ramfs/                 # Dossier de travail pour le initramfs
â”œâ”€â”€ run.sh                 # Pour exÃ©cuter le challenge (readonly)
â”œâ”€â”€ root.sh                # Pour exÃ©cuter ta version debug
â”œâ”€â”€ build.sh               # Script pour recompiler et rebuild lâ€™initramfs

```

Le but est donc de changer run.sh pour activer le DEBUG de qemu avec l'option `-s`
```
#!/bin/sh
qemu-system-x86_64 \
  -no-reboot \
  -cpu max \
  -net none \
  -serial mon:stdio \
  -display none \
  -monitor none \
  -vga none \
  -kernel bzImage \
  -initrd new-initramfs.img \
  -s \
  -append "console=ttyS0 loglevel=8 ignore_loglevel"
```

si le initramfs est compiler 

âœ… 1. DÃ©compresser le `initramfs` (`initrd.cpio.gz`) dans `ramfs/`
```bash
mkdir -p ramfs
cp initrd.cpio.gz ramfs/
cd ramfs
zcat initrd.cpio.gz | cpio -idvm
```

Puis dans `ramfs/init`, s'assurez que l'on est:
```bash
#!/bin/sh
mkdir -p /proc /sys /tmp
mount -t devtmpfs devtmpfs /dev
mkdir /dev/pts
mount -t devpts none /dev/pts
mount -t proc none /proc
mount -t sysfs none /sys
mount -t tmpfs none /tmp

mkdir /mnt
if mount -t 9p -o trans=virtio flag /mnt; then
    cp /mnt/flag.txt /flag.txt
    umount /mnt
else
    echo 'uiuctf{test_flag}' > /flag.txt
fi

chown 0:0 /flag.txt
chmod 0400 flag.txt

cat <<!

Welcome to baby-kernel!
Boot took $(cut -d' ' -f1 /proc/uptime) seconds
!

insmod vuln.ko
chmod 0666 /dev/vuln

exec setsid cttyhack setuidgid 1000 /bin/sh 0<>"/dev/ttyS0" 1>&0 2>&0

```

Enfin donner les droits root au init 
```
chmod +x init
```

Ensuite compiler le initramfs
```bash
find . -print0 | cpio --null -ov --format=newc | gzip -9 > ../new-initramfs.img
cd ..
```

Enfin rÃ©activer le debug 
```bash
#!/bin/bash
qemu-system-x86_64 \
  -kernel ./bzImage \
  -initrd ./new-initramfs.img \
  -append "console=ttyS0 nokaslr" \
  -nographic \
  -s -S
```
ğŸ”¸ `-s` lance GDB server sur le port `1234`  
ğŸ”¸ `-S` freeze lâ€™exÃ©cution jusqu'Ã  `gdb` attach

ğŸ§  GDB cÃ´tÃ© host
```
(gdb) target remote :1234
(gdb) b start_kernel
(gdb) c
```
